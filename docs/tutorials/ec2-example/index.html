<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300..800&display=swap" rel=stylesheet><link rel=stylesheet href=https://aws-controllers-k8s.github.io/community/main.b1688ea723c52a0cf3020e52ae6448e3e4f7dabcb0f290368ce2da5e7d35a0338635456bc7396a506b492f1a7919191602e3b77492eac8a0d0307a88d0d4c944.css integrity="sha512-sWiOpyPFKgzzAg5SrmRI4+T32ryw8pA2jOLaXn01oDOGNUVrxzlqUGtJLxp5GRkWAuO3dJLqyKDQMHqI0NTJRA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Manage a VPC Workflow with the ACK EC2-Controller - ACK</title><meta name=description content="Create and manage a network topology using ACK EC2-Controller deployed on Amazon Elastic Kubernetes Service (EKS) The ACK service controller for Elastic Compute Cloud (EC2-Controller) lets users manage EC2 resources directly from Kubernetes. This guide demonstrates how to deploy a basic network topology (consisting of VPC resources) using a single Kubernetes resource manifest."><link rel=canonical href=https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Manage a VPC Workflow with the ACK EC2-Controller"><meta property="og:description" content="Create and manage a network topology using ACK EC2-Controller deployed on Amazon Elastic Kubernetes Service (EKS) The ACK service controller for Elastic Compute Cloud (EC2-Controller) lets users manage EC2 resources directly from Kubernetes. This guide demonstrates how to deploy a basic network topology (consisting of VPC resources) using a single Kubernetes resource manifest."><meta property="og:url" content="https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/"><meta property="og:site_name" content="ACK"><meta property="og:image" content="https://aws-controllers-k8s.github.io/community/og.png"><meta property="og:image:alt" content="ACK"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@awscloud"><meta name=twitter:creator content><meta name=twitter:title content="Manage a VPC Workflow with the ACK EC2-Controller"><meta name=twitter:description content="Create and manage a network topology using ACK EC2-Controller deployed on Amazon Elastic Kubernetes Service (EKS) The ACK service controller for Elastic Compute Cloud (EC2-Controller) lets users manage EC2 resources directly from Kubernetes. This guide demonstrates how to deploy a basic network topology (consisting of VPC resources) using a single Kubernetes resource manifest."><meta name=twitter:image content="https://aws-controllers-k8s.github.io/community/og.png"><meta name=twitter:image:alt content="Manage a VPC Workflow with the ACK EC2-Controller"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://aws-controllers-k8s.github.io/#/schema/organization/1","name":"AWS Controllers for K8s","url":"https://aws-controllers-k8s.github.io/","sameAs":["https://twitter.com/awscloud","https://github.com/aws-controllers-k8s/community"],"logo":{"@type":"ImageObject","@id":"https://aws-controllers-k8s.github.io/#/schema/image/1","url":"https://aws-controllers-k8s.github.io/ack.png","width":512,"height":512,"caption":"AWS Controllers for K8s"},"image":{"@id":"https://aws-controllers-k8s.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://aws-controllers-k8s.github.io/#/schema/website/1","url":"https://aws-controllers-k8s.github.io/","name":"ACK","description":"Doks is a Hugo theme helping you build modern documentation websites that are secure, fast, and SEO-ready â€” by default.","publisher":{"@id":"https://aws-controllers-k8s.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/","url":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/","name":"Manage a VPC Workflow with the ACK EC2-Controller","description":"Create and manage a network topology using ACK EC2-Controller deployed on Amazon Elastic Kubernetes Service (EKS) The ACK service controller for Elastic Compute Cloud (EC2-Controller) lets users manage EC2 resources directly from Kubernetes. This guide demonstrates how to deploy a basic network topology (consisting of VPC resources) using a single Kubernetes resource manifest.","isPartOf":{"@id":"https://aws-controllers-k8s.github.io/#/schema/website/1"},"about":{"@id":"https://aws-controllers-k8s.github.io/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/"]}]},{"@type":"BreadcrumbList","@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://aws-controllers-k8s.github.io/community/","url":"https://aws-controllers-k8s.github.io/community/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://aws-controllers-k8s.github.io/community/docs/","url":"https://aws-controllers-k8s.github.io/community/docs/","name":"Docs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/","url":"https://aws-controllers-k8s.github.io/community/docs/tutorials/","name":"Tutorials"}},{"@type":"ListItem","position":4,"item":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://aws-controllers-k8s.github.io/#/schema/article/1","headline":"Manage a VPC Workflow with the ACK EC2-Controller","description":"Create and manage a network topology using ACK EC2-Controller deployed on Amazon Elastic Kubernetes Service (EKS) The ACK service controller for Elastic Compute Cloud (EC2-Controller) lets users manage EC2 resources directly from Kubernetes. This guide demonstrates how to deploy a basic network topology (consisting of VPC resources) using a single Kubernetes resource manifest.","isPartOf":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/"},"mainEntityOfPage":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","author":{"@id":"https://aws-controllers-k8s.github.io/#/schema/person/2"},"publisher":{"@id":"https://aws-controllers-k8s.github.io/#/schema/organization/1"},"image":{"@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://aws-controllers-k8s.github.io/#/schema/person/2","name":"AWS","sameAs":["https://twitter.com/awscloud","https://github.com/aws-controllers-k8s"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/#/schema/image/2","url":"https://aws-controllers-k8s.github.io/community/og.png","contentUrl":"https://aws-controllers-k8s.github.io/community/og.png","caption":"Manage a VPC Workflow with the ACK EC2-Controller"}]}]}</script><meta name=theme-color content="#ff9900"><link rel=apple-touch-icon sizes=180x180 href=https://aws-controllers-k8s.github.io/community/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://aws-controllers-k8s.github.io/community/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aws-controllers-k8s.github.io/community/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://aws-controllers-k8s.github.io/community/site.webmanifest><link rel=mask-icon color=#5bbad5 href=https://aws-controllers-k8s.github.io/community/safari-pinned-tab.svg><meta name=msapplication-TileColor content="#da532c"><script>(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body class="docs single d-flex flex-column h-100 dark"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label>
<a class="navbar-brand order-1 order-md-0 me-auto" href=https://aws-controllers-k8s.github.io/community/><span class="navbar-logo logo-light"><svg width="30" height="34" viewBox="0 0 64.386 62.635" xmlns="http://www.w3.org/2000/svg"><path d="m18.112 62.241c-.58208-.2097-1.0825-.38307-1.1121-.38526-.05964-.004-6.9703-8.5523-8.016-9.9151-.3638-.47411-1.8521-2.3244-3.3073-4.1118-6.169-7.5771-5.7671-6.894-5.6043-9.525.07652-1.2369.2681-2.6062.42574-3.0427.15763-.43656.88408-3.4726 1.6143-6.7469s1.4423-6.4294 1.5822-7.0115c.13998-.58209.49521-2.1299.78941-3.4396 1.3414-5.9718 1.3876-6.0514 4.3737-7.5406 1.313-.65484 3.9324-1.927 5.8208-2.8269 1.8885-.89995 6.3475-3.0258 9.9091-4.7242 7.7798-3.7099 7.4615-3.6736 12.178-1.3871 1.6735.81137 4.531 2.1853 6.35 3.0532 1.819.86788 4.4384 2.1189 5.8208 2.78 1.3824.66112 3.7644 1.7868 5.2931 2.5015 2.9983 1.4017 4.0296 2.3189 4.4852 3.9889.24392.89408.61395 2.4653 2.1314 9.0501.28504 1.2369.86914 3.7372 1.298 5.5562s.97374 4.2003 1.2108 5.2917c.2371 1.0914.56563 2.4425.73006 3.0024.50213 1.7098.37232 3.363-.34938 4.4494-.35422.53325-2.549 3.3137-4.8774 6.1788-2.3283 2.8651-4.531 5.6016-4.8948 6.0813-3.5052 4.6213-6.5923 8.1362-7.558 8.6052-1.0278.49922-1.6581.52197-14.155.51087-10.7-.01-13.272-.081-14.138-.39289zm14.42-14.853c1.993-.65861 4.1321-1.8055 5.208-2.7923l.57777-.52995.15829 1.0218c.37804 2.4404.25325 2.3447 3.0582 2.3447h2.5072v-12.965c0-14.742.01357-14.637-2.1954-17.096-2.2207-2.4725-5.3026-3.3183-11.157-3.0616-3.7392.16395-6.9101.77913-9.2875 1.8019l-1.3054.56157v2.2164c0 1.219.0817 2.2164.18156 2.2164s1.0226-.23473 2.0505-.52163c2.4182-.67492 6.8343-1.3304 8.9629-1.3304 2.0099.0 4.3168.63112 5.1681 1.4139 1.22 1.1218 1.459 1.9649 1.5795 5.5722.10844 3.2453.08971 3.4049-.37858 3.2252-.27096-.10398-1.6251-.35976-3.0091-.56841-6.4942-.979-10.999.005-14.067 3.0735-2.0011 2.0011-2.4548 3.2402-2.4641 6.7305-.0065 2.4258.08634 3.1141.55768 4.1334 1.179 2.5499 3.2925 4.2534 5.9416 4.9794 2.3169.63499 5.0434.52227 7.9127-.42589zm-5.3603-4.4174c-1.3419-.50246-1.7811-.90498-2.3487-2.1529-.96238-2.1156-.37837-5.1724 1.2299-6.4375 1.6643-1.3091 6.0181-1.7402 10.183-1.0084l1.7198.30217v6.6092l-1.4496.86623c-3.1522 1.8836-7.1071 2.6552-9.3347 1.8212z" stroke-width=".26458" style="fill:#212529"/><path style="fill:none;stroke-width:.271169" d="m97.026736 181.42372c-11.841729-2.08439-21.332462-9.10215-26.093859-19.29466-1.998022-4.27707-2.054194-4.6839-2.055098-14.88419-841e-6-9.49243.144169-11.16725 1.267846-14.64314 1.712817-5.29828 6.177554-10.936 12.299033-15.53024 2.542552-1.90822 7.390509-4.53026 10.594967-5.73033 8.933335-3.34556 20.674605-4.18152 34.409895-2.44995 4.41785.55695 12.65266 1.97363 14.19738 2.44244 1.76241.53489 1.85502.50959 2.22367-.60744.24279-.73566.28029-2.73516.14369-7.66053-.44788-16.149002-1.23751-19.911778-5.02917-23.965076-1.80821-1.932978-3.56225-2.973051-7.11557-4.219231-5.30124-1.859191-12.26098-2.569875-19.19872-1.960452-10.49153.921594-19.993865 2.573896-30.430988 5.291456l-5.619006 1.463045-.198978-.992725C76.31239 78.136699 76.217381 74.401849 76.210696 70.38303l-.01215-7.306943 3.356503-1.444983c10.517529-4.527823 21.216871-6.656502 37.293351-7.419665 12.51101-.593907 22.76653.582675 29.54824 3.389974 4.64166 1.921419 7.46417 3.920688 11.49419 8.14168 5.92808 6.208991 7.10885 9.292714 7.94906 20.759878.20234 2.761617.35353 19.385439.44083 48.471489l.13286 44.26837-6.87266-.008c-7.35796-.009-10.40797-.26157-11.45694-.94889-1.06894-.70039-1.56607-2.17132-2.37024-7.01314-.41845-2.51943-.81979-4.63975-.89185-4.71182-.0721-.0721-.94053.61073-1.92991 1.51732-2.61666 2.39769-6.17638 4.67392-11.10375 7.10019-7.00303 3.44832-13.15672 5.41292-19.90153 6.35366-4.14851.57862-11.25229.52696-14.85996-.10807zM117.9586 163.14859c7.66738-1.41157 14.24402-3.97835 21.89691-8.5461l3.72858-2.22546v-12.58107c0-11.74762-.0314-12.59038-.47455-12.72168-1.42309-.42168-10.77757-1.80215-14.1221-2.08405-4.68265-.39467-14.28993-.18758-17.80807.38387-8.70887 1.41459-13.028171 3.55254-15.811026 7.82606-2.230704 3.42561-3.30745 7.4555-3.304504 12.36763.0032 5.38208 1.685615 10.33001 4.555689 13.39835 1.872987 2.00238 6.082191 3.96008 9.779001 4.54822 2.10281.33454 8.92935.11855 11.56007-.36577z" transform="scale(0.26458333)"/></svg></span><span class="navbar-logo logo-dark d-none"><svg width="30" height="34" viewBox="0 0 64.386 62.635" xmlns="http://www.w3.org/2000/svg"><path d="m18.112 62.241c-.58208-.2097-1.0825-.38307-1.1121-.38526-.05964-.004-6.9703-8.5523-8.016-9.9151-.3638-.47411-1.8521-2.3244-3.3073-4.1118-6.169-7.5771-5.7671-6.894-5.6043-9.525.07652-1.2369.2681-2.6062.42574-3.0427.15763-.43656.88408-3.4726 1.6143-6.7469s1.4423-6.4294 1.5822-7.0115c.13998-.58209.49521-2.1299.78941-3.4396 1.3414-5.9718 1.3876-6.0514 4.3737-7.5406 1.313-.65484 3.9324-1.927 5.8208-2.8269 1.8885-.89995 6.3475-3.0258 9.9091-4.7242 7.7798-3.7099 7.4615-3.6736 12.178-1.3871 1.6735.81137 4.531 2.1853 6.35 3.0532 1.819.86788 4.4384 2.1189 5.8208 2.78 1.3824.66112 3.7644 1.7868 5.2931 2.5015 2.9983 1.4017 4.0296 2.3189 4.4852 3.9889.24392.89408.61395 2.4653 2.1314 9.0501.28504 1.2369.86914 3.7372 1.298 5.5562s.97374 4.2003 1.2108 5.2917c.2371 1.0914.56563 2.4425.73006 3.0024.50213 1.7098.37232 3.363-.34938 4.4494-.35422.53325-2.549 3.3137-4.8774 6.1788-2.3283 2.8651-4.531 5.6016-4.8948 6.0813-3.5052 4.6213-6.5923 8.1362-7.558 8.6052-1.0278.49922-1.6581.52197-14.155.51087-10.7-.01-13.272-.081-14.138-.39289zm14.42-14.853c1.993-.65861 4.1321-1.8055 5.208-2.7923l.57777-.52995.15829 1.0218c.37804 2.4404.25325 2.3447 3.0582 2.3447h2.5072v-12.965c0-14.742.01357-14.637-2.1954-17.096-2.2207-2.4725-5.3026-3.3183-11.157-3.0616-3.7392.16395-6.9101.77913-9.2875 1.8019l-1.3054.56157v2.2164c0 1.219.0817 2.2164.18156 2.2164s1.0226-.23473 2.0505-.52163c2.4182-.67492 6.8343-1.3304 8.9629-1.3304 2.0099.0 4.3168.63112 5.1681 1.4139 1.22 1.1218 1.459 1.9649 1.5795 5.5722.10844 3.2453.08971 3.4049-.37858 3.2252-.27096-.10398-1.6251-.35976-3.0091-.56841-6.4942-.979-10.999.005-14.067 3.0735-2.0011 2.0011-2.4548 3.2402-2.4641 6.7305-.0065 2.4258.08634 3.1141.55768 4.1334 1.179 2.5499 3.2925 4.2534 5.9416 4.9794 2.3169.63499 5.0434.52227 7.9127-.42589zm-5.3603-4.4174c-1.3419-.50246-1.7811-.90498-2.3487-2.1529-.96238-2.1156-.37837-5.1724 1.2299-6.4375 1.6643-1.3091 6.0181-1.7402 10.183-1.0084l1.7198.30217v6.6092l-1.4496.86623c-3.1522 1.8836-7.1071 2.6552-9.3347 1.8212z" stroke-width=".26458" style="fill:#fff"/><path style="fill:none;stroke-width:.271169" d="m97.026736 181.42372c-11.841729-2.08439-21.332462-9.10215-26.093859-19.29466-1.998022-4.27707-2.054194-4.6839-2.055098-14.88419-841e-6-9.49243.144169-11.16725 1.267846-14.64314 1.712817-5.29828 6.177554-10.936 12.299033-15.53024 2.542552-1.90822 7.390509-4.53026 10.594967-5.73033 8.933335-3.34556 20.674605-4.18152 34.409895-2.44995 4.41785.55695 12.65266 1.97363 14.19738 2.44244 1.76241.53489 1.85502.50959 2.22367-.60744.24279-.73566.28029-2.73516.14369-7.66053-.44788-16.149002-1.23751-19.911778-5.02917-23.965076-1.80821-1.932978-3.56225-2.973051-7.11557-4.219231-5.30124-1.859191-12.26098-2.569875-19.19872-1.960452-10.49153.921594-19.993865 2.573896-30.430988 5.291456l-5.619006 1.463045-.198978-.992725C76.31239 78.136699 76.217381 74.401849 76.210696 70.38303l-.01215-7.306943 3.356503-1.444983c10.517529-4.527823 21.216871-6.656502 37.293351-7.419665 12.51101-.593907 22.76653.582675 29.54824 3.389974 4.64166 1.921419 7.46417 3.920688 11.49419 8.14168 5.92808 6.208991 7.10885 9.292714 7.94906 20.759878.20234 2.761617.35353 19.385439.44083 48.471489l.13286 44.26837-6.87266-.008c-7.35796-.009-10.40797-.26157-11.45694-.94889-1.06894-.70039-1.56607-2.17132-2.37024-7.01314-.41845-2.51943-.81979-4.63975-.89185-4.71182-.0721-.0721-.94053.61073-1.92991 1.51732-2.61666 2.39769-6.17638 4.67392-11.10375 7.10019-7.00303 3.44832-13.15672 5.41292-19.90153 6.35366-4.14851.57862-11.25229.52696-14.85996-.10807zM117.9586 163.14859c7.66738-1.41157 14.24402-3.97835 21.89691-8.5461l3.72858-2.22546v-12.58107c0-11.74762-.0314-12.59038-.47455-12.72168-1.42309-.42168-10.77757-1.80215-14.1221-2.08405-4.68265-.39467-14.28993-.18758-17.80807.38387-8.70887 1.41459-13.028171 3.55254-15.811026 7.82606-2.230704 3.42561-3.30745 7.4555-3.304504 12.36763.0032 5.38208 1.685615 10.33001 4.555689 13.39835 1.872987 2.00238 6.082191 3.96008 9.779001 4.54822 2.10281.33454 8.92935.11855 11.56007-.36577z" transform="scale(0.26458333)"/></svg></span></a><button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/aws-controllers-k8s/community><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav flex-grow-1 main-nav me-auto order-5 order-md-2"><li class="nav-item active"><a class=nav-link href=https://aws-controllers-k8s.github.io/community/docs/community/overview/>Documentation</a></li><li class=nav-item><a class=nav-link href=https://aws-controllers-k8s.github.io/community/reference/>API Reference</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-introduction aria-expanded=false>
Introduction</button><div class="collapse collapsed" id=section-introduction><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/how-it-works/>How it Works</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/services/>Services</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/releases/>Release Phases</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-getting-started aria-expanded=false>
Getting Started</button><div class="collapse collapsed" id=section-getting-started><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/install/>Install an ACK Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/irsa/>Configure IAM Permissions</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/resource-crud/>Create an ACK Resource</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/multi-region-resource-management/>Manage Resources In Multiple Regions</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/cross-account-resource-management/>Manage Resources In Multiple AWS Accounts</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/authorization/>Permissions Overview</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/authentication/>Authentication and Credentials</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/field-export/>Copy a resource field into a ConfigMap or Secret</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/adopted-resource/>Adopting Existing AWS Resources</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/ack-tags/>Managing Tags on your AWS Resources</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/deletion-policy/>Retain AWS Resources after CR Deletion</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/openshift/>Red Hat OpenShift</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/user-docs/cleanup/>Uninstall an ACK Controller</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded" data-bs-toggle=collapse data-bs-target=#section-tutorials aria-expanded=true>
Tutorials</button><div class="collapse show" id=section-tutorials><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/sagemaker-example/>Machine Learning with the ACK SageMaker Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/autoscaling-example/>Scale SageMaker Workloads with Application Auto Scaling</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/rds-example/>Deploy PostgreSQL, MySQL, MariaDB Instances Using the ACK RDS Controller</a></li><li><a class="docs-link rounded active" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/ec2-example/>Manage a VPC Workflow with the ACK EC2-Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/apigatewayv2-reference-example/>Manage HTTP APIs with the ACK APIGatewayv2 Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/memorydb-example/>Create a managed Amazon MemoryDB for Redis Cluster using the ACK MemoryDB Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/aurora-serverless-v2/>Manage an Aurora Serverless v2 cluster with the ACK RDS Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/eventbridge-example/>Manage EventBridge event buses and rules with the ACK EventBridge Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/pipes-example/>Manage EventBridge Pipes with the ACK Pipes Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/sqs-example/>Manage SQS queues with the ACK SQS Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/lambda-oci-example/>Create a Lambda OCI Function with the ACK Lambda Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/tutorials/emr-on-eks-example/>Run Spark jobs using the ACK EMR on EKS controller</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-contributor aria-expanded=false>
Contributor Docs</button><div class="collapse collapsed" id=section-contributor><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/overview/>Contribution Overview</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/tenets/>Project Tenets</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/code-generation/>Code Generation</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/code-organization/>Code Organization</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/operatorhub-onboarding/>OperatorHub Onboarding</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/api-inference/>API Inference</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/setup/>Setup</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/building-controller/>Building a Controller</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/code-generator-config/>Understanding generator.yaml configuration</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/testing/>Testing</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/contributor-docs/release/>Release</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-discussion aria-expanded=false>
Discussion</button><div class="collapse collapsed" id=section-discussion><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/background/>Background</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/faq/>FAQ</a></li><li><a class="docs-link rounded" href=https://aws-controllers-k8s.github.io/community/docs/community/discussions/>Discussions</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><hr><span class=small><nav id=TableOfContents><ul><li><a href=#setup>Setup</a><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#install-ack-ec2-controller>Install ACK EC2-Controller</a></li><li><a href=#configure-iam-permissions>Configure IAM permissions</a></li><li><a href=#optional-create-a-vpc-and-subnet>[Optional] Create a VPC and Subnet</a></li><li><a href=#create-a-vpc-workflow>Create a VPC Workflow</a></li><li><a href=#validate>Validate</a></li><li><a href=#cleanup>Cleanup</a></li></ul></li></ul></nav></span></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Manage a VPC Workflow with the ACK EC2-Controller</h1><p class=lead>Create and manage a basic network topology using ACK EC2-Controller.</p><h2 id=setup>Setup<a href=#setup class=anchor aria-hidden=true>#</a></h2><p>Although it is not necessary to use Amazon Elastic Kubernetes Service (Amazon EKS) or Amazon Elastic Container Registry (Amazon ECR) with ACK, this guide assumes that you have
access to an Amazon EKS cluster. If this is your first time creating an Amazon EKS cluster and Amazon ECR repository, see <a href=https://docs.aws.amazon.com/deep-learning-containers/latest/devguide/deep-learning-containers-eks-setup.html>Amazon EKS Setup</a> and <a href=https://docs.aws.amazon.com/AmazonECR/latest/userguide/get-set-up-for-amazon-ecr.html>Amazon ECR Setup</a>.</p><h3 id=prerequisites>Prerequisites<a href=#prerequisites class=anchor aria-hidden=true>#</a></h3><p>This guide assumes that you have:</p><ul><li>Created an EKS cluster with Kubernetes version 1.16 or higher.</li><li>Have access to Amazon ECR</li><li>AWS IAM permissions to create roles and attach policies to roles.</li><li>Installed the following tools on the client machine used to access your Kubernetes cluster:<ul><li><a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv1.html>AWS CLI</a> - A command line tool for interacting with AWS services.</li><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html>kubectl</a> - A command line tool for working with Kubernetes clusters.</li><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html>eksctl</a> - A command line tool for working with EKS clusters.</li><li><a href=https://helm.sh/docs/intro/install/>Helm 3.8+</a> - A tool for installing and managing Kubernetes applications.</li><li><a href=https://docs.docker.com/engine/install/>Docker</a> - A tool to build, share, and run containers.</li></ul></li></ul><h3 id=install-ack-ec2-controller>Install ACK EC2-Controller<a href=#install-ack-ec2-controller class=anchor aria-hidden=true>#</a></h3><p>Deploy the EC2-Controller using the Helm chart, <a href=https://gallery.ecr.aws/aws-controllers-k8s/ec2-chart>ec2-chart</a>. Note, this example creates resources in the <code>us-west-2</code> region, but you can use any other region supported in AWS.</p><p>Log into the Helm registry that stores the ACK charts:</p><pre><code class=language-bash>aws ecr-public get-login-password --region us-east-1 | helm registry login --username AWS --password-stdin public.ecr.aws
</code></pre><p>Install Helm chart:</p><pre><code class=language-bash>export SERVICE=ec2
export AWS_REGION=&lt;aws region id&gt;
export RELEASE_VERSION=$(curl -sL &quot;https://api.github.com/repos/aws-controllers-k8s/${SERVICE}-controller/releases/latest&quot; | grep '&quot;tag_name&quot;:' | cut -d'&quot;' -f4)
helm install --create-namespace -n ack-system oci://public.ecr.aws/aws-controllers-k8s/ec2-chart &quot;--version=${RELEASE_VERSION}&quot; --generate-name --set=aws.region=${AWS_REGION}
</code></pre><p>Check the CRDs have been installed using <code>kubectl get crds</code>:</p><pre><code>NAME                                         CREATED AT
adoptedresources.services.k8s.aws            2022-10-15T01:58:26Z
dhcpoptions.ec2.services.k8s.aws             2022-10-15T01:58:26Z
elasticipaddresses.ec2.services.k8s.aws      2022-10-15T01:58:26Z
eniconfigs.crd.k8s.amazonaws.com             2022-09-30T23:00:32Z
fieldexports.services.k8s.aws                2022-10-15T01:58:26Z
instances.ec2.services.k8s.aws               2022-10-15T01:58:27Z
internetgateways.ec2.services.k8s.aws        2022-10-15T01:58:27Z
natgateways.ec2.services.k8s.aws             2022-10-15T01:58:27Z
routetables.ec2.services.k8s.aws             2022-10-15T01:58:27Z
securitygrouppolicies.vpcresources.k8s.aws   2022-09-30T23:00:35Z
securitygroups.ec2.services.k8s.aws          2022-10-15T01:58:28Z
subnets.ec2.services.k8s.aws                 2022-10-15T01:58:28Z
transitgateways.ec2.services.k8s.aws         2022-10-15T01:58:28Z
vpcendpoints.ec2.services.k8s.aws            2022-10-15T01:58:28Z
vpcs.ec2.services.k8s.aws                    2022-10-15T01:58:28Z
</code></pre><p>For a full list of available values in the Helm chart, refer to <a href=https://github.com/aws-controllers-k8s/ec2-controller/blob/main/helm/values.yaml>values.yaml</a>.</p><h3 id=configure-iam-permissions>Configure IAM permissions<a href=#configure-iam-permissions class=anchor aria-hidden=true>#</a></h3><p>The controller requires permissions to invoke EC2 APIs. Once the service controller is deployed <a href=https://aws-controllers-k8s.github.io/community/docs/user-docs/irsa/>configure the IAM permissions</a> using the value <code>SERVICE=ec2</code> throughout. The recommended IAM Policy for EC2-Controller can be found in <a href=https://github.com/aws-controllers-k8s/ec2-controller/blob/main/config/iam/recommended-policy-arn>recommended-policy-arn</a>.</p><h3 id=optional-create-a-vpc-and-subnet>[Optional] Create a VPC and Subnet<a href=#optional-create-a-vpc-and-subnet class=anchor aria-hidden=true>#</a></h3><p>This section is optional and will NOT be using a single manifest file to deploy the VPC and Subnet. The purpose of this section is to demonstrate a simple use case to shed light on some of the functionality before jumping into a more complex deployment.</p><p>Create the <strong>VPC</strong> using the provided YAML and <code>kubectl apply</code>:</p><pre><code>cat &lt;&lt;EOF &gt; vpc.yaml
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: VPC
metadata:
  name: vpc-tutorial-test
spec:
  cidrBlocks: 
  - 10.0.0.0/16
  enableDNSSupport: true
  enableDNSHostnames: true
EOF
 
kubectl apply -f vpc.yaml
</code></pre><p>Check the <strong>VPC</strong> <code>Status</code> using <code>kubectl describe</code>:</p><pre><code>&gt; kubectl describe vpcs
...
Status:
  Ack Resource Metadata:
    Owner Account ID:  &lt;ID&gt;
    Region:            us-west-2
  Cidr Block Association Set:
    Association ID:  vpc-cidr-assoc-&lt;ID&gt;
    Cidr Block:      10.0.0.0/16
    Cidr Block State:
      State:  associated
  Conditions:
    Last Transition Time:  2022-10-12T17:26:08Z
    Message:               Resource synced successfully
    Reason:
    Status:                True
    Type:                  ACK.ResourceSynced
  Dhcp Options ID:         dopt-&lt;ID&gt;
  Is Default:              false
  Owner ID:                &lt;ID&gt;
  State:                   available
  Vpc ID:                  vpc-&lt;ID&gt;
Events:                    &lt;none&gt;
</code></pre><p>The <strong>VPC</strong> resource synced successfully and is available. Note the <code>vpc-&lt;ID></code>.</p><p>Create the <strong>Subnet</strong> using <code>vpc-&lt;ID></code>, the provided YAML, and <code>kubectl apply</code>:</p><pre><code>cat &lt;&lt;EOF &gt; subnet.yaml
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: Subnet
metadata:
  name: subnet-tutorial-test
spec:
  cidrBlock: 10.0.0.0/20
  vpcID: vpc-&lt;ID&gt;
EOF
 
kubectl apply -f subnet.yaml
</code></pre><p>Check the <strong>Subnet</strong> availability and ID using <code>kubectl describe</code>:</p><pre><code>&gt; kubectl describe subnets
...
Status:
  Ack Resource Metadata:
    Arn:                       arn:aws:ec2:us-west-2:&lt;ID&gt;:subnet/subnet-&lt;ID&gt;
    Owner Account ID:          &lt;ID&gt;
    Region:                    us-west-2
  Available IP Address Count:  4091
  Conditions:
    Last Transition Time:           2022-10-12T17:36:53Z
    Message:                        Resource synced successfully
    Reason:
    Status:                         True
    Type:                           ACK.ResourceSynced
  Default For AZ:                   false
  Map Customer Owned IP On Launch:  false
  Owner ID:                         &lt;ID&gt;
  Private DNS Name Options On Launch:
  State:      available
  Subnet ID:  subnet-&lt;ID&gt;
Events:       &lt;none&gt;
</code></pre><p>Delete the resources:</p><ul><li><code>kubectl delete -f subnet.yaml</code></li><li><code>kubectl delete -f vpc.yaml</code></li></ul><p>Both resources were successfully deployed, managed, then deleted by their respective controllers. Although contrived, this example highlights how easy it can be to deploy AWS resources via YAML files and how it feels like managing any other K8s resource.</p><p>In this example, we used multiple YAML manifests and waited for the <code>vpcID</code> to be generated before manually updating the Subnet custom resources to reference that VPC ID. This technique is less aligned to a fully declarative, GitOps-style of configuration management because dependencies between resources need to be manually resolved using a specific order of operations. The next example uses a single YAML manifest to deploy an entire network topology using ACK Resource References, a technique that better aligns with a fully automated and declarative GitOps-style of configuration management.</p><h3 id=create-a-vpc-workflow>Create a VPC Workflow<a href=#create-a-vpc-workflow class=anchor aria-hidden=true>#</a></h3><p>In this section, we create a network topology consisting of multiple, connected resources using a single YAML manifest. The following resources are present in this network topology:</p><ul><li>1 VPC</li><li>1 Instance</li><li>1 Internet Gateway</li><li>1 NAT Gateways</li><li>1 Elastic IPs</li><li>2 Route Tables</li><li>2 Subnets (1 Public; 1 Private)</li><li>1 Security Group</li></ul><p><img src=../images/networktopology.png alt="Network Topology"></p><p>The VPC is connected to the Internet through an Internet Gateway. A NAT Gateway is created in the public Subnet with an associated Elastic IP. An Instance is deployed into the private Subnet which can connect to the Internet using the NAT Gateway in the public Subnet. Lastly, one Route Table (public) will contain a route to the Internet Gateway while the other Route Table (private) contains a route to the NAT Gateway.</p><div class="hint d-flex flex-column border-start my-4 border-4 hint-info"><div class="hint-title p-2 flex flex-row flex-items-center">Referencing Resources</div><div class="hint-body p-2 small"><p>Notice that the ACK custom resources reference each other using &ldquo;*Ref&rdquo; fields inside the manifest and the user does not have to worry about finding <code>vpc-ID</code> when creating the Subnet resource manifests.</p><p>Refer to <a href=https://aws-controllers-k8s.github.io/community/reference/>API Reference</a> for <em>EC2</em>
to find the supported reference fields.</p></div></div><p>Note, if the region used while installing the Helm chart is different from <code>us-west-2</code>, we need to modify availability zones and CIDR ranges in the provided YAML to match the needed region.</p><p>Deploy the resources using the provided YAML and <code>kubectl apply -f vpc-workflow.yaml</code>:</p><pre><code>cat &lt;&lt;EOF &gt; vpc-workflow.yaml
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: VPC
metadata:
  name: tutorial-vpc
spec:
  cidrBlocks: 
  - 10.0.0.0/16
  enableDNSSupport: true
  enableDNSHostnames: true
  tags:
    - key: name
      value: vpc-tutorial
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: InternetGateway
metadata:
  name: tutorial-igw
spec:
  vpcRef:
    from:
      name: tutorial-vpc
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: NATGateway
metadata:
  name: tutorial-natgateway1
spec:
  subnetRef:
    from:
      name: tutorial-public-subnet1
  allocationRef:
    from:
      name: tutorial-eip1
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: ElasticIPAddress
metadata:
  name: tutorial-eip1
spec:
  tags:
    - key: name
      value: eip-tutorial
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: RouteTable
metadata:
  name: tutorial-public-route-table
spec:
  vpcRef:
    from:
      name: tutorial-vpc
  routes:
  - destinationCIDRBlock: 0.0.0.0/0
    gatewayRef:
      from:
        name: tutorial-igw
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: RouteTable
metadata:
  name: tutorial-private-route-table-az1
spec:
  vpcRef:
    from:
      name: tutorial-vpc
  routes:
  - destinationCIDRBlock: 0.0.0.0/0
    natGatewayRef:
      from:
        name: tutorial-natgateway1
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: Subnet
metadata:
  name: tutorial-public-subnet1
spec:
  availabilityZone: us-west-2a
  cidrBlock: 10.0.0.0/20
  mapPublicIPOnLaunch: true
  vpcRef:
    from:
      name: tutorial-vpc
  routeTableRefs:
  - from:
      name: tutorial-public-route-table
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: Subnet
metadata:
  name: tutorial-private-subnet1
spec:
  availabilityZone: us-west-2a
  cidrBlock: 10.0.128.0/20
  vpcRef:
    from:
      name: tutorial-vpc
  routeTableRefs:
  - from:
      name: tutorial-private-route-table-az1
---
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: SecurityGroup
metadata:
  name: tutorial-security-group
spec:
  description: &quot;ack security group&quot;
  name: tutorial-sg
  vpcRef:
     from:
       name: tutorial-vpc
  ingressRules:
    - ipProtocol: tcp
      fromPort: 22
      toPort: 22
      ipRanges:
        - cidrIP: &quot;0.0.0.0/0&quot;
          description: &quot;ingress&quot;
EOF
</code></pre><p>The output should look similar to:</p><pre><code>vpc.ec2.services.k8s.aws/tutorial-vpc created
internetgateway.ec2.services.k8s.aws/tutorial-igw created
natgateway.ec2.services.k8s.aws/tutorial-natgateway1 created
elasticipaddress.ec2.services.k8s.aws/tutorial-eip1 created
routetable.ec2.services.k8s.aws/tutorial-public-route-table created
routetable.ec2.services.k8s.aws/tutorial-private-route-table-az1 created
subnet.ec2.services.k8s.aws/tutorial-public-subnet1 created
subnet.ec2.services.k8s.aws/tutorial-private-subnet1 created
securitygroup.ec2.services.k8s.aws/tutorial-security-group created
</code></pre><p>Check the resources you just created using <code>kubectl describe</code>:</p><pre><code>kubectl describe vpcs
kubectl describe internetgateways
kubectl describe routetables
kubectl describe natgateways
kubectl describe elasticipaddresses
kubectl describe subnets
kubectl describe securitygroups
</code></pre><p>Note that Subnet gets into an &lsquo;available&rsquo; state with a <code>ACK.ReferencesResolved = True</code> condition attached notifying users that the references (VPC, RouteTable) have been found and resolved:</p><pre><code>Status:
  Ack Resource Metadata:
    Arn:                       arn:aws:ec2:us-west-2:&lt;ID&gt;:subnet/subnet-0ba22f5820bb41584
    Owner Account ID:          &lt;ID&gt;
    Region:                    us-west-2
  Available IP Address Count:  4091
  Conditions:
    Last Transition Time:           2022-10-13T14:54:39Z
    Status:                         True
    Type:                           ACK.ReferencesResolved
    Last Transition Time:           2022-10-13T14:54:41Z
    Message:                        Resource synced successfully
    Reason:
    Status:                         True
    Type:                           ACK.ResourceSynced
  Default For AZ:                   false
  Map Customer Owned IP On Launch:  false
  Owner ID:                         515336597380
  Private DNS Name Options On Launch:
  State:      available
  Subnet ID:  subnet-&lt;ID&gt;
 
</code></pre><h3 id=validate>Validate<a href=#validate class=anchor aria-hidden=true>#</a></h3><p>This network setup should allow Instances deployed in the Private Subnet to connect to the Internet. To validate this behavior, deploy an Instance into the private Subnet and the public Subnet (bastion host). After waiting until the Instances are in an <code>available</code> state, <code>ssh</code> into the bastion host, then <code>ssh</code> into the private Subnet Instance, and test internet connectivity. A SecurityGroup is required by both instances launched in the public and private Subnets.</p><p>Note, we need to provide Subnet and SecurityGroup ID&rsquo;s in the yaml manually; run <code>kubectl describe subnets</code> and <code>kubectl describe securitygroups</code> commands to get ID&rsquo;s. We need to create key-pair via console and provide in yaml to launch instances.</p><p>Deploy an Instance into the Private Subnet using provided YAML and <code>kubectl apply -f tutorial-instance-private.yaml</code>:</p><pre><code>cat &lt;&lt;EOF &gt; tutorial-instance-private.yaml
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: Instance
metadata:
  name: tutorial-instance-private
spec:
  imageID: ami-02b92c281a4d3dc79 # AL2; us-west-2
  instanceType: c3.large
  subnetID: subnet-&lt;private-ID&gt;
  securityGroupIDs:
  - sg-&lt;ID&gt;
  keyName: us-west-2-key # created via console
  tags:
    - key: producer
      value: ack
EOF
</code></pre><p>Deploy the bastion host Instance into the Public Subnet using provided YAML and <code>kubectl apply -f tutorial-bastion-host.yaml</code>:</p><pre><code>cat &lt;&lt;EOF &gt; tutorial-bastion-host.yaml
apiVersion: ec2.services.k8s.aws/v1alpha1
kind: Instance
metadata:
  name: tutorial-bastion-host
spec:
  imageID: ami-02b92c281a4d3dc79 # AL2 in us-west-2
  instanceType: c3.large
  subnetID: subnet-&lt;public-ID&gt;
  securityGroupIDs:
  - sg-&lt;ID&gt;
  keyName: us-west-2-key # created via console
  tags:
    - key: producer
      value: ack
EOF
</code></pre><p>Validate if the instances are created successfully with <code>kubectl describe instances</code></p><p>If you see following type of error in the output of above command, then find one of the available instance types for your Region and Availability zone and replace in the above YAML files</p><pre><code>Message: Unsupported: Your requested instance type (c3.large) is not supported in your requested Availability Zone (us-west-2a). Please retry your request by not specifying an Availability Zone or choosing us-west-2b, us-west-2c, us-west-2d, us-west-2e.
</code></pre><p>You can use below command to find EC2 instance types supported in your AWS region and availability zone (for example, to check if c5.large is supported in us-west-2 region and us-west-2a availability zone):</p><pre><code>aws ec2 describe-instance-type-offerings --location-type &quot;availability-zone&quot; --filters Name=location,Values=us-west-2a --region us-west-2 --query &quot;InstanceTypeOfferings[*].[InstanceType]&quot; --output text | sort | grep c5.large
</code></pre><p>Find out IDs of the instances in public and private subnets by running this command <code>kubectl get instances</code></p><pre><code>NAME                      ID
tutorial-instance-private *i-xxxxxxxxxxxxxxxx*
tutorial-bastion-host *i-xxxxxxxxxxxxxxxx*
</code></pre><p>Note, we need to get <code>Public IPV4 DNS</code> for bastion host instance from EC2 console and substitute in the below commands. We can get the <code>Private IP</code> for private instance on running <code>kubectl describe instance tutorial-instance-private</code></p><p>Deployed 2 instances; one to each Subnet</p><ul><li>The instance in the public subnet will be the bastion host so we can ssh to the Instance in the private Subnet<pre><code class=language-bash>scp -i &quot;/path/created_key_in_console_for_region.pem&quot; &quot;/path/created_key_in_console_for_region.pem&quot; ec2-user@&lt;Public IPV4 DNS&gt;:
ssh -i &quot;/path/created_key_in_console_for_region.pem&quot; ec2-user@&lt;Public IPV4 DNS&gt;
ssh -i &quot;created_key_in_console_for_region.pem&quot; ec2-user@&lt;Private IP&gt;
</code></pre></li></ul><p>Validate instance in private subnet can connect to internet</p><ul><li>Try to ping websites from your private subnet, sample output looks like<pre><code class=language-bash>ping google.com

PING google.com (142.250.217.78) 56(84) bytes of data.
64 bytes from sea09s29-in-f14.1e100.net (142.250.217.78): icmp_seq=1 ttl=102 time=8.30 ms
64 bytes from sea09s29-in-f14.1e100.net (142.250.217.78): icmp_seq=2 ttl=102 time=7.82 ms
64 bytes from sea09s29-in-f14.1e100.net (142.250.217.78): icmp_seq=3 ttl=102 time=7.77 ms
^C
--- google.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
</code></pre></li></ul><h3 id=cleanup>Cleanup<a href=#cleanup class=anchor aria-hidden=true>#</a></h3><p>Remove all the resources using <code>kubectl delete</code> command.</p><pre><code class=language-bash>kubectl delete -f tutorial-bastion-host.yaml
kubectl delete -f tutorial-instance-private.yaml
kubectl delete -f vpc-workflow.yaml
</code></pre><p>Note, deleting resources can take a few minutes as we have couple of resources created using a single manifest, do not kill the <code>kubectl delete</code> command, wait until it finishes completely.</p><p>The output of delete commands should look like</p><pre><code class=language-bash>instance.ec2.services.k8s.aws &quot;tutorial-bastion-host&quot; deleted
instance.ec2.services.k8s.aws &quot;tutorial-instance-private&quot; deleted
vpc.ec2.services.k8s.aws/tutorial-vpc deleted
internetgateway.ec2.services.k8s.aws/tutorial-igw deleted
natgateway.ec2.services.k8s.aws/tutorial-natgateway1 deleted
elasticipaddress.ec2.services.k8s.aws/tutorial-eip1 deleted
routetable.ec2.services.k8s.aws/tutorial-public-route-table deleted
routetable.ec2.services.k8s.aws/tutorial-private-route-table-az1 deleted
subnet.ec2.services.k8s.aws/tutorial-public-subnet1 deleted
subnet.ec2.services.k8s.aws/tutorial-private-subnet1 deleted
securitygroup.ec2.services.k8s.aws/tutorial-security-group deleted
</code></pre><p>To remove the EC2 ACK service controller, related CRDs, and namespaces, see <a href=https://aws-controllers-k8s.github.io/community/docs/user-docs/cleanup/>ACK Cleanup</a>.</p><p>To delete your EKS clusters, see <a href=https://docs.aws.amazon.com/eks/latest/userguide/delete-cluster.html>Amazon EKS - Deleting a cluster</a>.</p><p class=edit-page><a href=https://github.com/aws-controllers-k8s/community/blob/main/docs/content/docs/tutorials/ec2-example.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class=my-n3></div></main></div></div></div><footer class="footer mt-auto text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://aws-controllers-k8s.github.io/community/js/bootstrap.min.586171fec3966d1a44fa8aa2edb24b861dc3a72be8cc24aa4e0dabe4c312a0dae5fe1eaa7c93180a6211fa4d7c5461b0d228fdf741be2eae279a376dfa1e7d81.js integrity="sha512-WGFx/sOWbRpE+oqi7bJLhh3DpyvozCSqTg2r5MMSoNrl/h6qfJMYCmIR+k18VGGw0ij990G+Lq4nmjdt+h59gQ==" crossorigin=anonymous defer></script>
<script src=https://aws-controllers-k8s.github.io/community/js/highlight.min.b9c3f53f62ede0586acf2866d3772ea55bf34115611a96523af51b289a2a58f9f60b82ffd4103276a6adc1a3bc7113c6ead0cf0799144d35605ff1e9108981bc.js integrity="sha512-ucP1P2Lt4Fhqzyhm03cupVvzQRVhGpZSOvUbKJoqWPn2C4L/1BAydqatwaO8cRPG6tDPB5kUTTVgX/HpEImBvA==" crossorigin=anonymous defer></script>
<script src=https://aws-controllers-k8s.github.io/community/main.min.491f43bd0e1cabe525a61ecfcb2738d89c578585b04b9ebbaf9d125b55595f3b76e5497375a1da0c840e16966c9a910aae60fba0790088c7869bee07c3be997c.js integrity="sha512-SR9DvQ4cq+Ulph7Pyyc42JxXhYWwS567r50SW1VZXzt25UlzdaHaDIQOFpZsmpEKrmD7oHkAiMeGm+4Hw76ZfA==" crossorigin=anonymous defer></script>
<script src=https://aws-controllers-k8s.github.io/community/index.min.846822e0c56649cc3197d1264e114bfa7680cb17b4794370a9284cf34f8dd5f1aeafd95bab7b9842d5cb9d9a495af317505882d6631f42e11545222b674816c8.js integrity="sha512-hGgi4MVmScwxl9EmThFL+naAyxe0eUNwqShM80+N1fGur9lbq3uYQtXLnZpJWvMXUFiC1mMfQuEVRSIrZ0gWyA==" crossorigin=anonymous defer></script></body></html>